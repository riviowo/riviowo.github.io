<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EryVanta — POL Payment</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b0f17; color:#e8eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .top { display:flex; align-items:center; justify-content:space-between; gap: 14px; flex-wrap:wrap; }
    .brand { display:flex; align-items:center; gap: 10px; }
    .logo { width: 34px; height: 34px; border-radius: 10px; background: linear-gradient(135deg,#111827,#1f2937); box-shadow: 0 10px 30px rgba(0,0,0,.35); display:grid; place-items:center; border: 1px solid rgba(255,255,255,.08); }
    .logo span { font-weight: 800; letter-spacing:.5px; opacity:.9; }
    .status { display:flex; align-items:center; gap: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); }
    #dot { width: 10px; height:10px; border-radius:50%; }
    #dot.on { background:#22c55e; box-shadow: 0 0 0 6px rgba(34,197,94,.15); }
    #dot.off { background:#ef4444; box-shadow: 0 0 0 6px rgba(239,68,68,.12); }
    .tabs { display:flex; gap:10px; margin-top: 18px; }
    .tab { cursor:pointer; padding: 10px 12px; border-radius: 12px; background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); user-select:none; }
    .tab.active { background: rgba(99,102,241,.15); border-color: rgba(99,102,241,.35); }
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; margin-top: 14px; }
    @media (min-width: 860px){ .grid { grid-template-columns: 1.2fr .8fr; } }
    .card { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 14px; }
    .row { display:flex; gap: 10px; flex-wrap:wrap; align-items:center; }
    button { cursor:pointer; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: #e8eefc; }
    button:hover { background: rgba(255,255,255,.10); }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .muted { opacity: .8; }
    .kv { display:grid; grid-template-columns: 140px 1fr; gap: 10px; margin-top: 10px; }
    .kv div { padding: 10px 12px; border-radius: 12px; background: rgba(0,0,0,.18); border: 1px solid rgba(255,255,255,.06); overflow-wrap:anywhere; }
    .view { display:none; }
    .view.active { display:block; }
    .msg { margin-top: 10px; padding: 10px 12px; border-radius: 12px; background: rgba(0,0,0,.25); border: 1px solid rgba(255,255,255,.08); min-height: 20px; }
    .hint { font-size: 12px; opacity:.85; line-height: 1.4; margin-top: 10px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"><span>EV</span></div>
        <div>
          <div style="font-weight:800;font-size:18px">EryVanta</div>
          <div class="muted" style="font-size:12px">Polygon (POL) — pay ≈ $0.10 in POL</div>
        </div>
      </div>

      <div class="status">
        <div id="dot" class="off"></div>
        <div id="status">Disconnected</div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="home">Home</div>
      <div class="tab" data-tab="shop">Shop</div>
      <div class="tab" data-tab="account">Account</div>
    </div>

    <div class="grid">
      <div class="card">
        <div id="view-home" class="view active">
          <div class="row">
            <button id="btnConnect">Connect + Sign</button>
            <button id="btnFixRpc" title="Update Polygon RPC in MetaMask">Fix Polygon RPC</button>
            <button id="btnLogout" disabled>Logout</button>
          </div>

          <div class="msg" id="sessionMsg"></div>

          <div class="kv">
            <div class="muted">Address</div><div id="addr">-</div>
            <div class="muted">Chain</div><div id="chain">-</div>
            <div class="muted">Balance (POL)</div><div id="bal">-</div>
          </div>

          <div class="hint">
            اگر MetaMask “Max fee” غیرعادی نشون داد، معمولاً مشکل از RPC / تخمین گس هست.
            دکمه <b>Fix Polygon RPC</b> رو بزن یا RPC شبکه Polygon داخل MetaMask رو عوض کن.
          </div>
        </div>

        <div id="view-shop" class="view">
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:800">Checkout</div>
              <div class="muted" style="font-size:12px">Pay in native POL (value ≈ $0.10)</div>
            </div>
            <div class="row">
              <button id="btnQuote">Refresh Quote</button>
              <button id="btnPay" disabled>Pay</button>
            </div>
          </div>

          <div class="kv">
            <div class="muted">Receiver</div><div id="receiver">-</div>
            <div class="muted">Target</div><div id="price">-</div>
            <div class="muted">Amount (POL)</div><div id="amountPol">-</div>
            <div class="muted">Oracle Price</div><div id="oraclePrice">-</div>
            <div class="muted">Updated</div><div id="updatedAt">-</div>
          </div>

          <div class="msg" id="shopMsg"></div>

          <div class="hint">
            مقدار POL با Chainlink (فید MATIC/USD روی Polygon) محاسبه می‌شود و به خاطر رُند کردن ممکن است کمی بیشتر از 0.10$ شود تا کمتر نشود. :contentReference[oaicite:2]{index=2}
          </div>
        </div>

        <div id="view-account" class="view">
          <div style="font-weight:800">Membership</div>
          <div class="kv">
            <div class="muted">Status</div><div id="mStatus">-</div>
            <div class="muted">TxHash</div><div id="mTx">-</div>
            <div class="muted">Verified</div><div id="mVerified">-</div>
          </div>
          <div class="hint">
            Verify یعنی: به همین آدرس، از همین ولت، دقیقاً همین مقدار wei پرداخت شده و receipt موفق بوده.
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800">Config</div>
        <div class="kv">
          <div class="muted">Network</div><div>Polygon Mainnet (ChainId 137 / 0x89)</div>
          <div class="muted">Oracle</div><div>Chainlink MATIC/USD feed</div>
          <div class="muted">Mode</div><div>≈ $0.10 in POL</div>
        </div>
        <div class="hint">
          <div>• اگر آدرس گیرنده قرارداد باشه، گس 21000 کافی نیست؛ این کد خودش تشخیص می‌ده.</div>
          <div>• Selector های ABI ثابت‌اند (مثلاً <code>latestRoundData()</code> = <code>0xfeaf968c</code>). :contentReference[oaicite:3]{index=3}</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   EryVanta — Pay ~$0.10 in POL
   - Uses Chainlink MATIC/USD feed on Polygon to convert USD->POL
   - Sends native POL transfer to MERCHANT_ADDRESS
========================= */

const el = (id) => document.getElementById(id);

const APP_NAME = "EryVanta";
const POLYGON_CHAIN_ID = "0x89"; // 137

// Receiver (change if you want)
const MERCHANT_ADDRESS = "0x03a6BC48ED8733Cc700AE49657931243f078a994";

// Target: $0.10 (10 cents)
const USD_TARGET_CENTS = 10n;

// Chainlink price feed on Polygon for MATIC/USD (used as POL/USD equivalent on PoS chain)
// Address shown as "Chainlink: MATIC/USD Price Feed" on Polygonscan
const CHAINLINK_MATIC_USD_FEED = "0xAB594600376Ec9fD91F8e885dADF0CE036862dE0";

// Function selectors (4 bytes)
// decimals()      => 0x313ce567
// latestRoundData()=> 0xfeaf968c
const SEL_DECIMALS = "0x313ce567";
const SEL_LATEST_ROUND_DATA = "0xfeaf968c";

// ChainList-style RPC candidates (HTTPS)
const POLYGON_RPC_CANDIDATES = [
  "https://polygon-bor-rpc.publicnode.com",
  "https://rpc.ankr.com/polygon",
  "https://1rpc.io/matic",
  "https://polygon.drpc.org",
  "https://polygon-rpc.com",
  "https://polygon-public.nodies.app",
];

const btnConnect = el("btnConnect");
const btnFixRpc = el("btnFixRpc");
const btnLogout = el("btnLogout");
const btnQuote = el("btnQuote");
const btnPay = el("btnPay");

let account = null;
let lastQuote = null;
let activeRpc = null;
let activateTab = () => {};

function setStatus(text, onOff) {
  el("status").textContent = text;
  const dot = el("dot");
  dot.classList.remove("on", "off");
  if (onOff === "on") dot.classList.add("on");
  if (onOff === "off") dot.classList.add("off");
}

function setSessionMsg(msg = "") {
  const node = el("sessionMsg");
  if (node) node.textContent = msg;
}

function toHex(bigint) {
  if (bigint < 0n) throw new Error("Negative BigInt not supported");
  return "0x" + bigint.toString(16);
}

function hexToBigInt(hex) {
  if (!hex || hex === "0x") return 0n;
  return BigInt(hex);
}

// parse int256 (two's complement)
function hexToSignedBigInt32Bytes(hex32) {
  // expects 0x + 64 hex chars
  const x = BigInt(hex32);
  const TWO_255 = 1n << 255n;
  const TWO_256 = 1n << 256n;
  return (x >= TWO_255) ? (x - TWO_256) : x;
}

function formatPolFromWei(weiBig, decimalsToShow = 6) {
  const base = 10n ** 18n;
  const whole = weiBig / base;
  const fracFull = (weiBig % base).toString().padStart(18, "0");
  const frac = fracFull.slice(0, decimalsToShow);
  return `${whole}.${frac}`;
}

function formatUsdFromPriceRaw(priceRaw, priceDecimals, decimalsToShow = 6) {
  const base = 10n ** BigInt(priceDecimals);
  const whole = priceRaw / base;
  const fracFull = (priceRaw % base).toString().padStart(Number(priceDecimals), "0");
  const frac = fracFull.slice(0, decimalsToShow);
  return `${whole}.${frac}`;
}

function centsToUsdString(cents) {
  const whole = cents / 100n;
  const frac = (cents % 100n).toString().padStart(2, "0");
  return `${whole}.${frac}`;
}

function nowIso() { return new Date().toISOString(); }

/* -----------------------
   Provider (MetaMask)
------------------------ */
async function requireProvider() {
  if (!window.ethereum) throw new Error("MetaMask نصب نیست.");
  return window.ethereum;
}

async function getChainIdWallet() {
  const provider = await requireProvider();
  return provider.request({ method: "eth_chainId" });
}

/* -----------------------
   RPC auto-failover layer
------------------------ */
function sleep(ms) { return new Promise((r) => setTimeout(r, ms)); }

async function rpcFetch(url, method, params = [], timeoutMs = 6500) {
  const ctrl = new AbortController();
  const t = setTimeout(() => ctrl.abort(), timeoutMs);
  try {
    const res = await fetch(url, {
      method: "POST",
      signal: ctrl.signal,
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ jsonrpc: "2.0", id: 1, method, params }),
    });
    if (!res.ok) throw new Error(`RPC HTTP ${res.status}`);
    const json = await res.json();
    if (json.error) throw new Error(json.error.message || "RPC error");
    return json.result;
  } finally {
    clearTimeout(t);
  }
}

async function isHealthyPolygonRpc(url) {
  const chainId = await rpcFetch(url, "eth_chainId", []);
  if (String(chainId).toLowerCase() !== POLYGON_CHAIN_ID) throw new Error("Wrong chainId");
  await rpcFetch(url, "eth_blockNumber", []);
  return true;
}

function getCachedRpc() {
  try {
    const x = JSON.parse(localStorage.getItem("eryvanta_polygon_rpc") || "null");
    if (!x || !x.url || !x.ts) return null;
    if (Date.now() - x.ts > 30 * 60 * 1000) return null; // 30 min
    return x.url;
  } catch { return null; }
}

function cacheRpc(url) {
  localStorage.setItem("eryvanta_polygon_rpc", JSON.stringify({ url, ts: Date.now() }));
}

async function pickHealthyPolygonRpc() {
  const cached = getCachedRpc();
  if (cached) { activeRpc = cached; return activeRpc; }

  for (const url of POLYGON_RPC_CANDIDATES) {
    try {
      await isHealthyPolygonRpc(url);
      activeRpc = url;
      cacheRpc(activeRpc);
      return activeRpc;
    } catch { /* try next */ }
  }
  throw new Error("هیچ RPC سالمی برای Polygon پیدا نشد. دوباره تلاش کن.");
}

async function rpcRequestPolygon(method, params = []) {
  if (!activeRpc) await pickHealthyPolygonRpc();

  const tried = new Set();
  const candidates = [activeRpc, ...POLYGON_RPC_CANDIDATES.filter((u) => u !== activeRpc)];

  for (const url of candidates) {
    if (tried.has(url)) continue;
    tried.add(url);
    try {
      const out = await rpcFetch(url, method, params, 7500);
      if (url !== activeRpc) { activeRpc = url; cacheRpc(activeRpc); }
      return out;
    } catch { /* try next */ }
  }
  throw new Error("Polygon RPC روی همه endpoint ها fail شد.");
}

async function ethCall(to, data) {
  return rpcRequestPolygon("eth_call", [{ to, data }, "latest"]);
}

/* -----------------------
   Chainlink price: POL/USD (via MATIC/USD feed)
------------------------ */
function sliceWord(data, wordIndex) {
  // data is 0x + (n*64 hex chars)
  const start = 2 + wordIndex * 64;
  const end = start + 64;
  return "0x" + data.slice(start, end);
}

async function getPolUsdFromChainlink() {
  await pickHealthyPolygonRpc();

  const decHex = await ethCall(CHAINLINK_MATIC_USD_FEED, SEL_DECIMALS);
  const priceDecimals = Number(hexToBigInt(decHex));

  const r = await ethCall(CHAINLINK_MATIC_USD_FEED, SEL_LATEST_ROUND_DATA);

  // latestRoundData(): (roundId, answer, startedAt, updatedAt, answeredInRound)
  const answerHex = sliceWord(r, 1);
  const updatedAtHex = sliceWord(r, 3);

  const answerSigned = hexToSignedBigInt32Bytes(answerHex);
  if (answerSigned <= 0n) throw new Error("Oracle returned invalid price.");

  const priceRaw = answerSigned; // USD per 1 POL * 10^decimals
  const updatedAt = Number(hexToBigInt(updatedAtHex)); // seconds

  return { priceRaw, priceDecimals, updatedAt };
}

function calcPayWeiForUsdCents(usdCents, priceRaw, priceDecimals) {
  // payWei = ceil( (usdCents/100 USD) * 10^priceDecimals * 1e18 / priceRaw )
  const numerator = usdCents * (10n ** BigInt(priceDecimals)) * (10n ** 18n);
  const denom = priceRaw * 100n;
  return (numerator + denom - 1n) / denom; // ceil division
}

/* -----------------------
   Network switching (Polygon)
------------------------ */
async function switchToPolygon() {
  const provider = await requireProvider();
  const current = await getChainIdWallet().catch(() => null);
  if (current && String(current).toLowerCase() === POLYGON_CHAIN_ID) return;

  const bestRpc = await pickHealthyPolygonRpc();

  try {
    await provider.request({
      method: "wallet_switchEthereumChain",
      params: [{ chainId: POLYGON_CHAIN_ID }],
    });
  } catch (err) {
    if (err && err.code === 4902) {
      await provider.request({
        method: "wallet_addEthereumChain",
        params: [{
          chainId: POLYGON_CHAIN_ID,
          chainName: "Polygon Mainnet",
          rpcUrls: [bestRpc, ...POLYGON_RPC_CANDIDATES.filter((x) => x !== bestRpc)],
          nativeCurrency: { name: "POL", symbol: "POL", decimals: 18 },
          blockExplorerUrls: ["https://polygonscan.com/"],
        }],
      });
    } else {
      throw err;
    }
  }
}

/* -----------------------
   Session + membership local storage
------------------------ */
function getSession() {
  try { return JSON.parse(localStorage.getItem("eryvanta_session") || "null"); }
  catch { return null; }
}
function setSession(s) { localStorage.setItem("eryvanta_session", JSON.stringify(s)); }
function clearSession() { localStorage.removeItem("eryvanta_session"); }

function getMembership() {
  try { return JSON.parse(localStorage.getItem("eryvanta_membership") || "null"); }
  catch { return null; }
}
function setMembership(m) { localStorage.setItem("eryvanta_membership", JSON.stringify(m)); }

function isSignedIn() {
  const s = getSession();
  return Boolean(
    s && s.account && s.sig && s.message &&
    account && s.account.toLowerCase() === account.toLowerCase()
  );
}

/* -----------------------
   UI helpers
------------------------ */
function setLoggedOutUI() {
  setStatus("Disconnected", "off");
  setSessionMsg("");
  el("addr").textContent = "-";
  el("chain").textContent = "-";
  el("bal").textContent = "-";
  btnLogout.disabled = true;
  btnPay.disabled = true;
}

async function refreshWalletUI() {
  if (!account) return;

  el("addr").textContent = account;
  btnLogout.disabled = false;

  // chain id (prefer wallet)
  try {
    el("chain").textContent = await getChainIdWallet();
  } catch {
    try { el("chain").textContent = await rpcRequestPolygon("eth_chainId", []); }
    catch { el("chain").textContent = "?"; }
  }

  // balance (prefer wallet; fallback to our RPC)
  try {
    const balHex = await window.ethereum.request({
      method: "eth_getBalance",
      params: [account, "latest"],
    });
    el("bal").textContent = formatPolFromWei(hexToBigInt(balHex));
  } catch {
    setSessionMsg("RPC متامسک مشکل دارد. Fix Polygon RPC را بزن یا RPC شبکه Polygon را در MetaMask تغییر بده.");
    try {
      const balHex = await rpcRequestPolygon("eth_getBalance", [account, "latest"]);
      el("bal").textContent = formatPolFromWei(hexToBigInt(balHex));
    } catch {
      el("bal").textContent = "?";
    }
  }

  setStatus("Connected", "on");
  await refreshMembershipUI().catch(() => {});
}

/* -----------------------
   Quote (≈ $0.10 in POL)
------------------------ */
async function refreshQuote() {
  el("shopMsg").textContent = "";
  el("receiver").textContent = MERCHANT_ADDRESS;

  try {
    await pickHealthyPolygonRpc();

    const { priceRaw, priceDecimals, updatedAt } = await getPolUsdFromChainlink();

    // Basic staleness check (2 hours)
    const nowSec = Math.floor(Date.now() / 1000);
    if (updatedAt === 0 || (nowSec - updatedAt) > 2 * 60 * 60) {
      throw new Error("Oracle price seems stale. Try again later.");
    }

    const payWei = calcPayWeiForUsdCents(USD_TARGET_CENTS, priceRaw, priceDecimals);

    lastQuote = {
      wei: payWei.toString(),
      usdCents: USD_TARGET_CENTS.toString(),
      priceRaw: priceRaw.toString(),
      priceDecimals,
      updatedAt,
      mode: "usd_oracle_chainlink",
    };

    el("price").textContent = `≈ $${centsToUsdString(USD_TARGET_CENTS)}`;
    el("amountPol").textContent = `${formatPolFromWei(payWei)} POL`;
    el("oraclePrice").textContent = `$${formatUsdFromPriceRaw(priceRaw, priceDecimals)} / POL`;
    el("updatedAt").textContent = new Date(updatedAt * 1000).toISOString();

    btnPay.disabled = !isSignedIn();
  } catch (e) {
    btnPay.disabled = true;
    el("price").textContent = "-";
    el("amountPol").textContent = "-";
    el("oraclePrice").textContent = "-";
    el("updatedAt").textContent = "-";
    el("shopMsg").textContent = e?.message || String(e);
  }
}

/* -----------------------
   Tx verify helpers
------------------------ */
async function waitForReceipt(txHash, timeoutMs = 120000) {
  const start = Date.now();
  while (Date.now() - start < timeoutMs) {
    const r = await rpcRequestPolygon("eth_getTransactionReceipt", [txHash]);
    if (r) return r;
    await sleep(2500);
  }
  throw new Error("Timed out waiting for confirmation.");
}

async function verifyTx(txHash, expectedWeiStr) {
  const tx = await rpcRequestPolygon("eth_getTransactionByHash", [txHash]);
  if (!tx) return { ok: false, reason: "Transaction not found." };

  const to = (tx.to || "").toLowerCase();
  const from = (tx.from || "").toLowerCase();
  const valueWei = BigInt(tx.value || "0x0");
  const expectedWei = BigInt(expectedWeiStr);

  if (to !== MERCHANT_ADDRESS.toLowerCase()) return { ok: false, reason: "Receiver mismatch." };
  if (!account || from !== account.toLowerCase()) return { ok: false, reason: "Sender mismatch." };
  if (valueWei !== expectedWei) return { ok: false, reason: "Amount mismatch." };

  const receipt = await rpcRequestPolygon("eth_getTransactionReceipt", [txHash]);
  if (!receipt) return { ok: false, reason: "Receipt not found yet." };
  if (receipt.status !== "0x1") return { ok: false, reason: "Transaction failed." };

  return { ok: true, reason: "Verified." };
}

async function refreshMembershipUI() {
  const m = getMembership();
  if (!m || !account) {
    el("mStatus").textContent = "Inactive";
    el("mTx").textContent = "-";
    el("mVerified").textContent = "-";
    return;
  }

  el("mTx").textContent = m.txHash || "-";

  if (m.account?.toLowerCase() !== account.toLowerCase()) {
    el("mStatus").textContent = "Inactive";
    el("mVerified").textContent = "No (different wallet)";
    return;
  }

  try {
    await pickHealthyPolygonRpc();
    const v = await verifyTx(m.txHash, m.expectedWei);
    el("mStatus").textContent = v.ok ? "Active" : "Inactive";
    el("mVerified").textContent = v.ok ? "Yes" : `No (${v.reason})`;
  } catch (e) {
    el("mStatus").textContent = "Unknown";
    el("mVerified").textContent = e?.message || String(e);
  }
}

/* -----------------------
   Tabs
------------------------ */
function setupTabs() {
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const views = { home: el("view-home"), shop: el("view-shop"), account: el("view-account") };

  function activate(name) {
    tabs.forEach((t) => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(views).forEach(([k, v]) => v.classList.toggle("active", k === name));
    if (name === "shop") refreshQuote();
    if (name === "account") refreshMembershipUI();
  }

  activateTab = activate;
  tabs.forEach((t) => t.addEventListener("click", () => activate(t.dataset.tab)));
}

/* -----------------------
   Connect + Sign
------------------------ */
async function connectWallet() {
  await requireProvider();
  const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
  account = accounts?.[0] || null;
  if (!account) throw new Error("هیچ اکانتی انتخاب نشد.");
  await refreshWalletUI();
}

async function signIn() {
  const provider = await requireProvider();
  const message = [
    `Sign in to ${APP_NAME}`,
    `Address: ${account}`,
    `Time: ${nowIso()}`,
  ].join("\n");

  const sig = await provider.request({
    method: "personal_sign",
    params: [message, account],
  });

  setSession({ account, sig, message });
}

/* -----------------------
   Safer tx params (avoid crazy max fee)
------------------------ */
async function isContractAddress(addr) {
  const code = await rpcRequestPolygon("eth_getCode", [addr, "latest"]);
  return code && code !== "0x";
}
function minBigInt(a, b) { return a < b ? a : b; }

/* -----------------------
   Button handlers
------------------------ */
btnConnect.onclick = async () => {
  try {
    setSessionMsg("");
    await connectWallet();
    if (!isSignedIn()) await signIn();
    activateTab("shop");
    await refreshQuote();
  } catch (e) {
    setStatus(e?.message || String(e), "off");
  }
};

if (btnFixRpc) {
  btnFixRpc.onclick = async () => {
    try {
      setSessionMsg("");
      const provider = await requireProvider();
      const bestRpc = await pickHealthyPolygonRpc();

      await provider.request({
        method: "wallet_addEthereumChain",
        params: [{
          chainId: POLYGON_CHAIN_ID,
          chainName: "Polygon Mainnet",
          rpcUrls: [bestRpc, ...POLYGON_RPC_CANDIDATES.filter((x) => x !== bestRpc)],
          nativeCurrency: { name: "POL", symbol: "POL", decimals: 18 },
          blockExplorerUrls: ["https://polygonscan.com/"],
        }],
      });

      setSessionMsg("در MetaMask درخواست آپدیت Polygon ارسال شد. Approve کن و دوباره تست کن.");
    } catch (e) {
      setSessionMsg(e?.message || String(e));
    }
  };
}

btnLogout.onclick = () => {
  clearSession();
  btnPay.disabled = true;
  el("shopMsg").textContent = "Signed out.";
};

btnQuote.onclick = async () => { await refreshQuote(); };

btnPay.onclick = async () => {
  try {
    el("shopMsg").textContent = "";

    if (!account) throw new Error("اول کیف پول را وصل کن.");
    if (!isSignedIn()) throw new Error("اول Sign in (signature) انجام بده.");

    await pickHealthyPolygonRpc();
    await switchToPolygon();

    // Fresh quote right before pay
    await refreshQuote();
    if (!lastQuote) throw new Error("Quote available نیست.");

    const expectedWei = BigInt(lastQuote.wei);

    // Cap gas price to avoid MetaMask showing crazy "max fee"
    const netGasPrice = BigInt(await rpcRequestPolygon("eth_gasPrice", []));
    const GAS_PRICE_CAP = 150n * 10n ** 9n; // 150 gwei cap
    const gasPrice = minBigInt(netGasPrice, GAS_PRICE_CAP);

    const toIsContract = await isContractAddress(MERCHANT_ADDRESS);

    const txParams = {
      from: account,
      to: MERCHANT_ADDRESS,
      value: toHex(expectedWei),
      gasPrice: toHex(gasPrice),
      ...(toIsContract ? {} : { gas: toHex(21000n) }),
    };

    el("shopMsg").textContent = "Opening MetaMask...";
    const txHash = await window.ethereum.request({
      method: "eth_sendTransaction",
      params: [txParams],
    });

    el("shopMsg").textContent = "Waiting for confirmation...";
    await waitForReceipt(txHash);

    setMembership({
      account,
      txHash,
      expectedWei: expectedWei.toString(),
      purchasedAt: nowIso(),
      mode: "usd_0_10_chainlink",
      chainId: POLYGON_CHAIN_ID,
      oracle: {
        feed: CHAINLINK_MATIC_USD_FEED,
        updatedAt: lastQuote.updatedAt,
        priceRaw: lastQuote.priceRaw,
        priceDecimals: lastQuote.priceDecimals,
        usdCents: lastQuote.usdCents,
      }
    });

    el("shopMsg").textContent = "Payment confirmed (≈ $0.10 in POL).";
    await refreshMembershipUI();
  } catch (e) {
    el("shopMsg").textContent = e?.message || String(e);
  }
};

/* -----------------------
   Init
------------------------ */
(async function init() {
  setupTabs();
  el("receiver").textContent = MERCHANT_ADDRESS;
  setStatus("Disconnected", "off");
  setSessionMsg("");

  // Pre-pick a healthy RPC silently
  pickHealthyPolygonRpc().catch(() => {});

  if (!window.ethereum) {
    setLoggedOutUI();
    return;
  }

  window.ethereum.on("accountsChanged", (accs) => {
    account = accs?.[0] || null;
    if (!account) setLoggedOutUI();
    else refreshWalletUI();
  });

  window.ethereum.on("chainChanged", () => {
    if (account) refreshWalletUI();
  });

  // silent reconnect (no popup)
  const accs = await window.ethereum.request({ method: "eth_accounts" });
  account = accs?.[0] || null;
  if (account) await refreshWalletUI();
  else setLoggedOutUI();
})();
</script>
</body>
</html>
